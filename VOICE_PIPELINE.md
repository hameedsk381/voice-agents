# Enterprise Voice Pipeline Documentation

This document outlines the end-to-end flow of the OpenVoice Orchestrator pipeline, focusing on the integration of enterprise-grade control and safety layers.

## 1. Interaction Entry (WebSocket)
The pipeline begins when a client connects to `/ws/{agent_id}`. 
- **Session Context:** A unique `session_id` is generated and tracked globally via Redis.
- **Version Pinning:** The orchestrator checks if the agent is pinned to a specific `AgentVersion`.
- **Latency Budgeting:** Each turn is assigned a strict processing budget (e.g., 2.5s). If a reasoning path (LangGraph) exceeds this, the system enters **Degradation Mode**, providing a cached "hold" response to maintain engagement.

## 2. Input Processing & Fast Path
- **STT:** User audio is transcribed with confidence scores.
- **Fast Path Turn Identification:** The orchestrator checks if the input is a simple acknowledgement or greeting.
    - **If Fast Path:** Responds instantly using a lightweight cached generator, bypassing expensive LLM reasoning to save cost and latency.
- **Human Takeover Check:** Checks for `HUMAN_TAKEOVER` intervention.
    - **If Active:** The AI is bypassed. The orchestrator waits for a human supervisor's text response from the HITL queue.
    - **If Inactive:** The transcript proceeds to the Policy Engine.

## 3. The Guardian Layer
- **Confidence-Aware Pipeline:** Intent detection and STT results are assigned confidence scores. 
    - **Low Confidence Handoff:** If the system is unsure (e.g., `< 50%` confidence), it triggers a specific clarification prompt or escalates to a human instead of hallucinating.
- **Sentiment Slope Analysis:** The system tracks the moving average of user sentiment. A consistently negative slope triggers **Predictive Escalation** before a formal violation occurs.
- **Input Validation:** The `PolicyEngine` validates the transcript against the current conversation state.
    - **Guardrails:** Regex pattern matching (e.g., blocking profanity).
    - **Intent Filtering:** Ensuring the user isn't trying to force the agent into an unsupported state.
    - **State Transition:** If valid, the state machine transitions (e.g., `GREETING` -> `DATA_COLLECTION`).

## 4. Intelligence & Orchestration
- **Agent Selection:** Based on the context and state, the orchestrator select the appropriate specialist agent persona.
- **Strategy Selection:**
    - **LangGraph:** For complex multi-agent workflows.
    - **Tool-Calling:** If external API actions are required (e.g., checking order status).
    - **Standard LLM:** For direct conversational response generation.
- **Whisper Mode:** If in `WHISPER` mode, the AI response is replaced/guided by a human supervisor's suggestion.

## 5. Response Safety (Output Policy)
- **Script Enforcement:** If the current state has a `enforce_script` defined, the agent is forced to use that exact wording.
- **PII Masking:** The `PolicyEngine` scans the AI output for sensitive data (Emails, Credit Cards) and masks them before synthesis.
- **Output Guardrails:** Final check to ensure the LLM didn't hallucinate disallowed promises or content.

## 6. Memory & Truth Layer
- **Typed Memory:** Information is categorized (e.g., `USER_CLAIM` vs `SYSTEM_VERIFIED`). 
- **Verifiable Truths:** Only verified facts can influence high-stakes policy decisions, protecting against LLM hallucinations of user-provided data.

## 7. Audio Synthesis (TTS & Streaming)
- **Sentence Buffering:** Text is buffered into sentences to ensure natural prosody during synthesis.
- **Streaming:** Audio chunks are streamed back to the user via WebSocket as they are generated by **QwenTTS** or **Deepgram**, minimizing Time-to-First-Audio (TTFA).

## 8. Compliance & Audit (Shadow Layer)
This happens in the background to avoid blocking the voice interaction:
- **Shadow Audit:** The `ComplianceValidator` audits the turn against industry-specific regulatory rules using an independent LLM check.
- **Risk Scoring:** A risk score is assigned based on violation severity.
- **Audit Logging:** An immutable record is saved to the database, containing redacted transcripts and the compliance outcome.
- **Alerting:** Critical violations trigger real-time events to the supervisor monitoring dashboard.

---

## Technical Stack
- **Orchestration:** Python / FastAPI / Asyncio
- **Policy Engine:** Custom State Machine + Guardrails
- **Real-time HITL:** Redis Pub/Sub
- **STT/TTS:** Deepgram / QwenTTS
- **Intelligence:** Groq (Llama 3) / OpenAI / LangGraph
